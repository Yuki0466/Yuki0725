<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“ç²¾é€‰ç®¡ç†</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .manager-container { padding: 20px; }
        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 30px; 
        }
        .stat-card { 
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; 
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }
        .product-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; margin-top: 20px; 
        }
        .product-card { 
            background: white; padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .product-card.featured { 
            border-color: #667eea; 
            background: linear-gradient(45deg, #f8f9ff, white);
        }
        .product-actions { margin-top: 15px; }
        .btn { 
            padding: 8px 16px; margin: 5px; border: none; 
            border-radius: 4px; cursor: pointer; 
        }
        .btn-featured { background: #667eea; color: white; }
        .btn-regular { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .badge { 
            padding: 4px 8px; border-radius: 12px; font-size: 12px; 
            margin-left: 10px; 
        }
        .badge-featured { background: #667eea; color: white; }
        .badge-regular { background: #6c757d; color: white; }
        .category { color: #666; font-size: 0.9em; }
        .price { color: #667eea; font-weight: bold; font-size: 1.2em; }
        .log-area { 
            background: #f8f9fa; padding: 15px; border-radius: 8px; 
            margin-top: 20px; max-height: 200px; overflow-y: auto; 
            font-family: monospace; font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="manager-container">
        <h1>ğŸ›ï¸ äº§å“ç²¾é€‰ç®¡ç†å·¥å…·</h1>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div>æ€»äº§å“æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="featuredProducts">0</div>
                <div>ç²¾é€‰äº§å“</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCategories">0</div>
                <div>æ€»åˆ†ç±»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgPrice">Â¥0</div>
                <div>å¹³å‡ä»·æ ¼</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div>
            <button onclick="loadProducts()" class="btn btn-success">ğŸ”„ é‡æ–°åŠ è½½</button>
            <button onclick="clearAllFeatured()" class="btn btn-regular">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç²¾é€‰</button>
            <button onclick="setTop3Featured()" class="btn btn-featured">â­ è®¾ç½®å‰3ä¸ºç²¾é€‰</button>
            <button onclick="setRandomFeatured(5)" class="btn btn-featured">ğŸ² éšæœº5ä¸ªç²¾é€‰</button>
            <button onclick="testPermission()" class="btn btn-success">ğŸ§ª æµ‹è¯•æƒé™</button>
        </div>

        <!-- äº§å“åˆ—è¡¨ -->
        <div id="productsContainer" class="product-grid"></div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://nysrxrlwrlcfrbhutwtd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55c3J4cmx3cmxjZnJiaHV0d3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTQ4MzgsImV4cCI6MjA3OTM5MDgzOH0.598J9S18JqKaqYP5e1lR_oKtly0pyhCzZ3FRJS0rwRI';
        
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allProducts = [];
        let allCategories = [];

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML = `[${timestamp}] ${message}\n` + logArea.innerHTML;
        }

        async function loadProducts() {
            log('ğŸ”„ å¼€å§‹åŠ è½½æ•°æ®...');
            
            try {
                // åŠ è½½äº§å“æ•°æ®
                const { data: products, error: productError } = await supabase
                    .from('products')
                    .select('*, categories(name)');

                // åŠ è½½åˆ†ç±»æ•°æ®
                const { data: categories, error: categoryError } = await supabase
                    .from('categories')
                    .select('*');

                if (productError) throw productError;
                if (categoryError) throw categoryError;

                allProducts = products || [];
                allCategories = categories || [];

                log(`âœ… åŠ è½½å®Œæˆ: ${allProducts.length} ä¸ªäº§å“, ${allCategories.length} ä¸ªåˆ†ç±»`);
                
                updateStats();
                displayProducts();
                
            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        function updateStats() {
            const totalProducts = allProducts.length;
            const featuredProducts = allProducts.filter(p => p.featured).length;
            const totalCategories = allCategories.length;
            const avgPrice = allProducts.length > 0 
                ? allProducts.reduce((sum, p) => sum + parseFloat(p.price || 0), 0) / allProducts.length 
                : 0;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('featuredProducts').textContent = featuredProducts;
            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('avgPrice').textContent = `Â¥${avgPrice.toFixed(2)}`;
        }

        function displayProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';

            allProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = `product-card ${product.featured ? 'featured' : ''}`;
                
                const categoryName = product.categories?.name || 'æœªåˆ†ç±»';
                const featuredBadge = product.featured 
                    ? '<span class="badge badge-featured">â­ ç²¾é€‰</span>' 
                    : '<span class="badge badge-regular">ğŸ“¦ æ™®é€š</span>';

                card.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <h3>${product.name}</h3>
                        ${featuredBadge}
                    </div>
                    <p class="category">ğŸ“ ${categoryName}</p>
                    <p style="margin: 10px 0;">${product.description || 'æ— æè¿°'}</p>
                    <div class="price">Â¥${parseFloat(product.price || 0).toFixed(2)}</div>
                    <p>ğŸ“¦ åº“å­˜: ${product.stock || 0}</p>
                    
                    <div class="product-actions">
                        ${product.featured 
                            ? `<button onclick="toggleFeatured('${product.id}', false)" class="btn btn-regular">è®¾ä¸ºæ™®é€š</button>`
                            : `<button onclick="toggleFeatured('${product.id}', true)" class="btn btn-featured">è®¾ä¸ºç²¾é€‰</button>`
                        }
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function toggleFeatured(productId, makeFeatured) {
            const action = makeFeatured ? 'è®¾ä¸ºç²¾é€‰' : 'è®¾ä¸ºæ™®é€š';
            log(`ğŸ”„ å°†äº§å“ ${productId} ${action}...`);
            
            try {
                log(`ğŸ“ æŸ¥è¯¢å‚æ•°: id=${productId}, featured=${makeFeatured}`);
                
                const { data, error } = await supabase
                    .from('products')
                    .update({ featured: makeFeatured })
                    .eq('id', productId)
                    .select();

                log(`ğŸ“Š æ›´æ–°ç»“æœ: data=${JSON.stringify(data)}, error=${error ? error.message : 'æ— '}`);

                if (error) {
                    log(`âŒ è¯¦ç»†é”™è¯¯ä¿¡æ¯: ${JSON.stringify(error)}`);
                    throw error;
                }
                
                log(`âœ… äº§å“ ${action} æˆåŠŸ`);
                loadProducts(); // é‡æ–°åŠ è½½æ•°æ®
                
            } catch (error) {
                log(`âŒ æ“ä½œå¤±è´¥: ${error.message}`);
                log(`ğŸ” é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`);
            }
        }

        async function clearAllFeatured() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç²¾é€‰çŠ¶æ€å—ï¼Ÿ')) return;
            
            log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç²¾é€‰çŠ¶æ€...');
            
            try {
                log('ğŸ“ æ‰§è¡Œ: UPDATE products SET featured = false');
                
                const { data, error } = await supabase
                    .from('products')
                    .update({ featured: false })
                    .select();

                log(`ğŸ“Š æ¸…é™¤ç»“æœ: data=${JSON.stringify(data)}, error=${error ? JSON.stringify(error) : 'æ— '}`);

                if (error) {
                    log(`âŒ æ¸…é™¤å¤±è´¥: ${error.message}`);
                    log(`ğŸ” é”™è¯¯ä»£ç : ${error.code}, è¯¦æƒ…: ${error.details}`);
                } else {
                    log(`âœ… æ¸…é™¤æˆåŠŸ: ${data?.length || 0} ä¸ªäº§å“è¢«æ›´æ–°`);
                    loadProducts();
                }
                
            } catch (error) {
                log(`âŒ æ¸…é™¤å¼‚å¸¸: ${error.message}`);
                log(`ğŸ” å¼‚å¸¸å †æ ˆ: ${error.stack}`);
            }
        }

        async function setTop3Featured() {
            log('â­ è®¾ç½®ä»·æ ¼æœ€é«˜çš„å‰3ä¸ªäº§å“ä¸ºç²¾é€‰...');
            
            try {
                // è·å–ä»·æ ¼æœ€é«˜çš„3ä¸ªäº§å“ID
                const top3Ids = allProducts
                    .sort((a, b) => parseFloat(b.price || 0) - parseFloat(a.price || 0))
                    .slice(0, 3)
                    .map(p => p.id);

                // å…ˆæ¸…é™¤æ‰€æœ‰ç²¾é€‰
                await supabase.from('products').update({ featured: false });
                
                // è®¾ç½®å‰3ä¸ªä¸ºç²¾é€‰
                const { error } = await supabase
                    .from('products')
                    .update({ featured: true })
                    .in('id', top3Ids);

                if (error) throw error;
                
                log(`âœ… è®¾ç½®æˆåŠŸ: ${top3Ids.join(', ')}`);
                loadProducts();
                
            } catch (error) {
                log(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        async function setRandomFeatured(count) {
            log(`ğŸ² éšæœºè®¾ç½® ${count} ä¸ªäº§å“ä¸ºç²¾é€‰...`);
            
            try {
                // éšæœºé€‰æ‹©äº§å“ID
                const randomIds = allProducts
                    .sort(() => Math.random() - 0.5)
                    .slice(0, count)
                    .map(p => p.id);

                // å…ˆæ¸…é™¤æ‰€æœ‰ç²¾é€‰
                await supabase.from('products').update({ featured: false });
                
                // è®¾ç½®éšæœºé€‰æ‹©çš„äº§å“ä¸ºç²¾é€‰
                const { error } = await supabase
                    .from('products')
                    .update({ featured: true })
                    .in('id', randomIds);

                if (error) throw error;
                
                log(`âœ… éšæœºè®¾ç½®æˆåŠŸ: ${randomIds.length} ä¸ªäº§å“`);
                loadProducts();
                
            } catch (error) {
                log(`âŒ éšæœºè®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        async function testPermission() {
            log('ğŸ§ª æµ‹è¯•æ•°æ®åº“æƒé™...');
            
            if (allProducts.length === 0) {
                log('âŒ è¯·å…ˆåŠ è½½äº§å“æ•°æ®');
                return;
            }
            
            const testProductId = allProducts[0].id;
            const currentFeatured = allProducts[0].featured;
            
            try {
                log(`ğŸ“ æµ‹è¯•æ›´æ–°äº§å“ ${testProductId} ä» ${currentFeatured} åˆ° ${!currentFeatured}`);
                
                const { data, error } = await supabase
                    .from('products')
                    .update({ featured: !currentFeatured })
                    .eq('id', testProductId)
                    .select();

                if (error) {
                    log(`âŒ æƒé™æµ‹è¯•å¤±è´¥: ${JSON.stringify(error)}`);
                    
                    if (error.code === '42501') {
                        log('ğŸ” è¿™æ˜¯æƒé™é”™è¯¯ï¼Œéœ€è¦æ‰§è¡Œ fix-permissions.sql');
                    }
                } else {
                    log(`âœ… æƒé™æµ‹è¯•æˆåŠŸ: æ›´æ–°äº† ${data?.length || 0} ä¸ªäº§å“`);
                    loadProducts();
                }
                
            } catch (error) {
                log(`âŒ æƒé™æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = () => {
            loadProducts();
        };
    </script>
</body>
</html>