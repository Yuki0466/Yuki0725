<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´è¯Šæ–­å·¥å…·</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
        .info { background-color: #d1ecf1; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; max-height: 300px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase æ•°æ®åº“å®Œæ•´è¯Šæ–­</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ è¯Šæ–­æ­¥éª¤</h3>
        <ol>
            <li>æ£€æŸ¥åŸºç¡€è¿æ¥</li>
            <li>æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨</li>
            <li>æ£€æŸ¥æ•°æ®æƒé™</li>
            <li>æ£€æŸ¥æ•°æ®å†…å®¹</li>
            <li>æµ‹è¯•ä¸ä¸»åº”ç”¨ç›¸åŒçš„æ•°æ®åŠ è½½é€»è¾‘</li>
        </ol>
    </div>

    <div class="test-section">
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://nysrxrlwrlcfrbhutwtd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55c3J4cmx3cmxjZnJiaHV0d3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTQ4MzgsImV4cCI6MjA3OTM5MDgzOH0.598J9S18JqKaqYP5e1lR_oKtly0pyhCzZ3FRJS0rwRI';
        
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const results = document.getElementById('results');

        function addResult(title, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <div class="result">${message}</div>
            `;
            results.appendChild(div);
        }

        function addJsonResult(title, data, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        async function testConnection() {
            try {
                addResult('ğŸ”Œ æµ‹è¯• 1: åŸºç¡€è¿æ¥', 'æ­£åœ¨æµ‹è¯• Supabase è¿æ¥...', 'info');
                
                // æµ‹è¯•åŸºç¡€è¿æ¥ - å°è¯•è®¿é—®ä¸€ä¸ªå·²çŸ¥å­˜åœ¨çš„è¡¨ï¼ˆå³ä½¿æ˜¯ç©ºçš„ï¼‰
                const { data, error } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        addResult('âŒ æµ‹è¯• 1: åŸºç¡€è¿æ¥', 'products è¡¨ä¸å­˜åœ¨ï¼è¯·å…ˆåˆ›å»ºæ•°æ®åº“è¡¨', 'error');
                    } else {
                        addResult('âŒ æµ‹è¯• 1: åŸºç¡€è¿æ¥', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    }
                    return false;
                }
                
                addResult('âœ… æµ‹è¯• 1: åŸºç¡€è¿æ¥', 'è¿æ¥æˆåŠŸï¼Supabase æœåŠ¡å¯è®¿é—®', 'success');
                return true;
            } catch (error) {
                addResult('âŒ æµ‹è¯• 1: åŸºç¡€è¿æ¥', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        async function testTablesExist() {
            try {
                addResult('ğŸ“Š æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', 'æ£€æŸ¥ products è¡¨æ˜¯å¦å­˜åœ¨...', 'info');
                
                // æµ‹è¯•è¡¨æ˜¯å¦å­˜åœ¨
                const { data, error } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        addResult('âŒ æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', 'products è¡¨ä¸å­˜åœ¨ï¼è¯·æ‰§è¡Œ SQL è„šæœ¬åˆ›å»ºè¡¨', 'error');
                        return false;
                    } else {
                        addResult('âŒ æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', `è¡¨è®¿é—®é”™è¯¯: ${error.message}`, 'error');
                        return false;
                    }
                }
                
                addResult('âœ… æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', 'products è¡¨å­˜åœ¨ä¸”å¯è®¿é—®', 'success');

                // æ£€æŸ¥åˆ†ç±»è¡¨
                const { data: catData, error: catError } = await supabase
                    .from('categories')
                    .select('count')
                    .limit(1);

                if (catError) {
                    addResult('âš ï¸ æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', `categories è¡¨è®¿é—®é—®é¢˜: ${catError.message}`, 'warning');
                } else {
                    addResult('âœ… æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', 'categories è¡¨ä¹Ÿå­˜åœ¨ä¸”å¯è®¿é—®', 'success');
                }
                
                return true;
            } catch (error) {
                addResult('âŒ æµ‹è¯• 2: æ£€æŸ¥è¡¨ç»“æ„', `è¡¨æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function testPermissions() {
            try {
                addResult('ğŸ” æµ‹è¯• 3: æ£€æŸ¥æƒé™ç­–ç•¥', 'æ£€æŸ¥ RLS ç­–ç•¥...', 'info');
                
                // æµ‹è¯•æ˜¯å¦æœ‰è¯»å–æƒé™
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);

                if (error) {
                    addResult('âŒ æµ‹è¯• 3: æ£€æŸ¥æƒé™ç­–ç•¥', `æƒé™è¢«æ‹’ç»: ${error.message}`, 'error');
                    addResult('ğŸ’¡ æµ‹è¯• 3: æ£€æŸ¥æƒé™ç­–ç•¥', 'å»ºè®®æ£€æŸ¥ Supabase æ§åˆ¶å°ä¸­çš„ RLS ç­–ç•¥è®¾ç½®', 'warning');
                    return false;
                }
                
                addResult('âœ… æµ‹è¯• 3: æ£€æŸ¥æƒé™ç­–ç•¥', 'æœ‰è¯»å–æƒé™ï¼ŒRLS ç­–ç•¥é…ç½®æ­£ç¡®', 'success');
                return true;
            } catch (error) {
                addResult('âŒ æµ‹è¯• 3: æ£€æŸ¥æƒé™ç­–ç•¥', `æƒé™æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDataContent() {
            try {
                addResult('ğŸ“‹ æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹', 'æŸ¥è¯¢å®é™…æ•°æ®...', 'info');
                
                // æŸ¥è¯¢äº§å“æ•°æ®
                const { data: products, error: productError } = await supabase
                    .from('products')
                    .select('*')
                    .limit(5);

                if (productError) {
                    addResult('âŒ æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹', `äº§å“æ•°æ®æŸ¥è¯¢å¤±è´¥: ${productError.message}`, 'error');
                    return false;
                }

                if (!products || products.length === 0) {
                    addResult('âš ï¸ æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹', 'äº§å“æ•°æ®ä¸ºç©ºï¼è¯·æ‰§è¡Œ init-data.sql æ’å…¥ç¤ºä¾‹æ•°æ®', 'warning');
                    return false;
                }

                addResult(`âœ… æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹`, `æ‰¾åˆ° ${products.length} æ¡äº§å“æ•°æ®`, 'success');
                addJsonResult('äº§å“æ•°æ®æ ·ä¾‹', products);

                // æŸ¥è¯¢åˆ†ç±»æ•°æ®
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .limit(5);

                if (catError) {
                    addResult('âš ï¸ æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹', `åˆ†ç±»æ•°æ®æŸ¥è¯¢é—®é¢˜: ${catError.message}`, 'warning');
                } else {
                    addResult(`âœ… æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹`, `æ‰¾åˆ° ${categories ? categories.length : 0} æ¡åˆ†ç±»æ•°æ®`, 'success');
                    if (categories && categories.length > 0) {
                        addJsonResult('åˆ†ç±»æ•°æ®æ ·ä¾‹', categories);
                    }
                }
                
                return true;
            } catch (error) {
                addResult('âŒ æµ‹è¯• 4: æ£€æŸ¥æ•°æ®å†…å®¹', `æ•°æ®æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAppLogic() {
            try {
                addResult('ğŸ¯ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', 'æµ‹è¯•ä¸ä¸»åº”ç”¨ç›¸åŒçš„æ•°æ®åŠ è½½ä»£ç ...', 'info');
                
                // å¤åˆ¶ä¸»åº”ç”¨ä¸­çš„ exact ä»£ç é€»è¾‘
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('featured', true)
                    .limit(6);

                console.log('ä¸»åº”ç”¨é€»è¾‘æµ‹è¯• - Supabase æŸ¥è¯¢ç»“æœ:', { data, error });

                if (error) {
                    addResult('âŒ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', `ç²¾é€‰äº§å“æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    addResult('ğŸ’¡ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', 'è¿™å°±æ˜¯ä¸»åº”ç”¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®çš„åŸå› ï¼', 'error');
                    return false;
                }

                if (!data || data.length === 0) {
                    addResult('âš ï¸ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', 'æ²¡æœ‰ç²¾é€‰äº§å“æ•°æ®ï¼æ£€æŸ¥æ˜¯å¦æœ‰ featured=true çš„äº§å“', 'warning');
                    addResult('ğŸ’¡ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', 'è¿™å°±æ˜¯ä¸»åº”ç”¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®çš„åŸå›  - æ•°æ®ä¸ºç©º', 'warning');
                    
                    // å°è¯•æŸ¥è¯¢æ‰€æœ‰äº§å“
                    const { data: allProducts, error: allError } = await supabase
                        .from('products')
                        .select('*')
                        .limit(3);
                    
                    if (!allError && allProducts && allProducts.length > 0) {
                        addResult('ğŸ’¡ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', `ä½†æ•°æ®åº“ä¸­æœ‰ ${allProducts.length} ä¸ªäº§å“ï¼Œåªæ˜¯æ²¡æœ‰æ ‡è®°ä¸ºç²¾é€‰`, 'info');
                        addJsonResult('éç²¾é€‰äº§å“æ ·ä¾‹', allProducts);
                    }
                    return false;
                }

                addResult(`âœ… æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘`, `æˆåŠŸåŠ è½½ ${data.length} ä¸ªç²¾é€‰äº§å“ï¼ä¸»åº”ç”¨åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤º`, 'success');
                addJsonResult('ç²¾é€‰äº§å“æ•°æ®', data);
                return true;
                
            } catch (error) {
                addResult('âŒ æµ‹è¯• 5: æ¨¡æ‹Ÿä¸»åº”ç”¨é€»è¾‘', `ä¸»åº”ç”¨é€»è¾‘æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­', 'æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            
            const results = [];
            results.push(await testConnection());
            results.push(await testTablesExist());
            results.push(await testPermissions());
            results.push(await testDataContent());
            results.push(await testAppLogic());

            const summary = results.every(r => r === true);
            addResult(
                summary ? 'ğŸ‰ è¯Šæ–­å®Œæˆ' : 'âš ï¸ è¯Šæ–­å‘ç°é—®é¢˜', 
                summary ? 'æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¸»åº”ç”¨åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºæ•°æ®' : 'å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šé¢çš„è¯¦ç»†æŠ¥å‘Š',
                summary ? 'success' : 'warning'
            );
        }

        function clearResults() {
            results.innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = () => {
            setTimeout(runAllTests, 1000);
        };
    </script>
</body>
</html>